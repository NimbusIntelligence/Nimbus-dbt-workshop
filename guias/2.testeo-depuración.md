# Testeo y Debugeo

1. Crea una nueva carpeta en el directorio models llamada library_loans (/models/library_loans).

2. Crea un nuevo archivo en la carpeta library_loans llamado customers_with_late_fees.sql (/models/library_loans/customers_with_late_fees.sql) y copia/pega el siguiente SQL dentro de él.

   ```sql
   WITH CTE AS (
       SELECT
           COALESCE(FAC.book_name, FIC.book_name) as book_name,
           M.member_name,
           M.discount_rate/100 as discount_applied,
           SUM(L.late_fee * (M.discount_rate/100)) as fee_applied
       FROM DBT_WORKSHOP_DB.library_loans.members AS M
           INNER JOIN DBT_WORKSHOP_DB.library_loans.loans AS L ON M.member_id = L.member_id
           LEFT JOIN DBT_WORKSHOP_DB.library_loans.books_factual AS FAC ON FAC.book_id=L.book_id
           LEFT JOIN DBT_WORKSHOP_DB.library_loans.books_fictional AS FIC ON FIC.book_id=L.book_id
       GROUP BY 1,2,3
   )
   SELECT
   member_name,
   listagg(book_name::text, ',') as late_books,
   discount_applied,
   ROUND(SUM(fee_applied),2) as fee_to_pay
   FROM CTE
   GROUP BY 1,3
   ```

3. Crea un archivo schema.yml en la carpeta library_loans (/models/library_loans/schema.yml) y copia/pega el siguiente SQL dentro de él.

   ```yml
   version: 2

   sources:
     - name: library
       database: DBT_WORKSHOP_DB
       schema: library_loans
       tables:
         - name: books_factual
         - name: books_fictional
         - name: loans
         - name: members
   ```

   Esto creará nuestras fuentes para que dbt pueda referenciarlas.

4. Actualiza la sección de models del archivo dbt_project.yml (líneas 38-45) para que todo lo que esté en library_loans se materialice por defecto como tablas.

   ```yml
   models:
     my_new_project:
       # Applies to all files under models/example/
       example:
         +materialized: table

       lego:
         +materialized: table

       library_loans:
         +materialized: table
   ```

5. Actualiza customers_with_late_fees.sql para que utilice las fuentes definidas (sources) en lugar de los valores codificados directamente.

   ```sql
   WITH CTE AS (
       SELECT
           COALESCE(FAC.book_name, FIC.book_name) as book_name,
           M.member_name,
           M.discount_rate/100 as discount_applied,
           SUM(L.late_fee * (M.discount_rate/100)) as fee_applied
       FROM {{ source('library', 'members') }} AS M
           INNER JOIN {{ source('library', 'loans') }} AS L ON M.member_id = L.member_id
           LEFT JOIN {{ source('library', 'books_factual') }} AS FAC ON FAC.book_id=L.book_id
           LEFT JOIN {{ source('library', 'books_fictional') }} AS FIC ON FIC.book_id=L.book_id
       GROUP BY 1,2,3
   )
   SELECT
   member_name,
   listagg(book_name::text, ',') as late_books,
   discount_applied,
   ROUND(SUM(fee_applied),2) as fee_to_pay
   FROM CTE
   GROUP BY 1,3
   ```

6. Agrega pruebas de primary key a nuestras claves primarias:

- test de unique y not null para:
  - books(fictional/factual).Book_id
  - members.member_id
  - loans.loan_id

```yml
version: 2

sources:
  - name: library
    database: DBT_WORKSHOP_DB
    schema: library_loans
    tables:
      - name: books_factual
        columns:
          - name: book_id
            data_tests:
              - unique
              - not_null
      - name: books_fictional
        columns:
          - name: book_id
            data_tests:
              - unique
              - not_null
      - name: loans
        columns:
          - name: loan_id
            data_tests:
              - unique
              - not_null
      - name: members
        columns:
          - name: member_id
            data_tests:
              - unique
              - not_null
```

7. Verifica que solo tengamos niveles de membresía 'Oro', 'Plata' y 'Bronce'.

```yml
version: 2

sources:
  - name: library
    database: DBT_WORKSHOP_DB
    schema: library_loans
    tables:
      - name: books_factual
        columns:
          - name: book_id
            data_tests:
              - unique
              - not_null
      - name: books_fictional
        columns:
          - name: book_id
            data_tests:
              - unique
              - not_null
      - name: loans
        columns:
          - name: loan_id
            data_tests:
              - unique
              - not_null
      - name: members
        columns:
          - name: member_id
            data_tests:
              - unique
              - not_null
          - name: membership_tier
            data_tests:
              - accepted_values:
                  values: ["Bronze", "Silver", "Gold"]
```

8. En la barra de comandos, ejecuta el comando

   ```sh
   dbt test --select library_loans
   ```

   7 deberian pasar, 2 deberian fallar.

9. Crea un nuevo modelo en library_loans llamado stg_members.sql ("/models/library_loans/stg_members.sql")

10. Copia/pega el siguiente SQL en el nuevo modelo.

    ```sql
    SELECT *
    FROM {{ source("library", "members") }}
    WHERE member_id IS NOT NULL
    AND membership_tier IN ('Bronze', 'Silver', 'Gold')
    ```

    Esto crea un modelo de staging que cumple con nuestras restricciones para los datos de nuevos miembros.

11. En el archivo schema.yml de library_loans, toma las pruebas de members (líneas 26-33) y aplícalas al nuevo stg_members dentro de un bloque de models.

    ```yml
    version: 2

    sources:
      - name: library
        database: DBT_WORKSHOP_DB
        schema: library_loans
        tables:
          - name: books_factual
            columns:
              - name: book_id
                data_tests:
                  - unique
                  - not_null
          - name: books_fictional
            columns:
              - name: book_id
                data_tests:
                  - unique
                  - not_null
          - name: loans
            columns:
              - name: loan_id
                data_tests:
                  - unique
                  - not_null
          - name: members

    models:
      - name: stg_members
        columns:
          - name: member_id
            data_tests:
              - unique
              - not_null
          - name: membership_tier
            data_tests:
              - accepted_values:
                  values: ["Bronze", "Silver", "Gold"]
    ```

12. En la barra de comandos, ejecuta el comando

    ```sh
    dbt build --select library_loans
    ```

    La prueba de valores aceptados ahora debería pasar, pero el book_id único de los libros ficticios todavía debería fallar.

13. Crea un nuevo modelo en library_loans llamado stg_books.sql ("/models/library_loans/stg_books.sql").

14. Copia/pega el siguiente SQL en el nuevo modelo.

    ```sql
    SELECT
    book_id,
    location,
    book_name,
    'Fact' as genre
    FROM {{ source("library", "books_factual") }}
    WHERE book_id IS NOT NULL
    UNION
    SELECT
    book_id,
    location,
    book_name,
    'Fiction' as genre
    FROM {{ source("library", "books_fictional") }}
    WHERE book_id IS NOT NULL
    ```

    Esto combina tanto los libros ficticios como los reales en una sola tabla, eliminando cualquier book_id nulo.

15. En el archivo schema.yml de library_loans, elimina las pruebas de book_id (líneas 9-13 y 15-19) y aplica una sola prueba de book_id no nula y única al nuevo modelo stg_books en la sección de modelos.

    ```yml
    version: 2

    sources:
      - name: library
        database: DBT_WORKSHOP_DB
        schema: library_loans
        tables:
          - name: books_factual
          - name: books_fictional
          - name: loans
            columns:
              - name: loan_id
                data_tests:
                  - unique
                  - not_null
          - name: members

    models:
      - name: stg_members
        columns:
          - name: member_id
            data_tests:
              - unique
              - not_null
          - name: membership_tier
            data_tests:
              - accepted_values:
                  values: ["Bronze", "Silver", "Gold"]
      - name: stg_books
        columns:
          - name: book_id
            data_tests:
              - unique
              - not_null
    ```

16. En la barra de comandos, ejecuta el comando

    ```sh
    dbt build --select library_loans
    ```

    Todas las pruebas deberían pasar ahora.

17. Agrega pruebas de relación a nuestra fuente de préstamos (loans):

    - loans.book_id
      - tiene una relación con stg_books.book_id
    - loans.member_id
      - tiene una relación con stg_members.member_id

    ```yml
    version: 2

    sources:
      - name: library
        database: DBT_WORKSHOP_DB
        schema: library_loans
        tables:
          - name: books_factual
          - name: books_fictional
          - name: loans
            columns:
              - name: loan_id
                data_tests:
                  - unique
                  - not_null
              - name: book_id
                data_tests:
                  - relationships:
                      to: ref('stg_books')
                      field: book_id
              - name: member_id
                data_tests:
                  - relationships:
                      to: ref('stg_members')
                      field: member_id
          - name: members

    models:
      - name: stg_members
        columns:
          - name: member_id
            data_tests:
              - unique
              - not_null
          - name: membership_tier
            data_tests:
              - accepted_values:
                  values: ["Bronze", "Silver", "Gold"]
      - name: stg_books
        columns:
          - name: book_id
            data_tests:
              - unique
              - not_null
    ```

18. En la barra de comandos, ejecuta el comando

    ```sh
    dbt test --select library_loans
    ```

    Algunas pruebas fallarán.

19. Crea un nuevo modelo en library_loans llamado stg_loans.sql (/models/library_loans/stg_loans.sql).

20. Copia/pega el siguiente SQL en el nuevo modelo.

    ```sql
    SELECT *
    FROM {{ source("library", "loans") }}
    WHERE loan_id IS NOT NULL
    AND book_id IS NOT NULL
    AND member_id IS NOT NULL
    AND book_id IN (SELECT book_id FROM {{ ref('stg_books') }})
    AND member_id IN (SELECT member_id FROM {{ ref('stg_members') }})
    ```

    Esto aplica nuestras pruebas de “not null” y además verifica la integridad referencial con nuestras claves foráneas (book_id y member_id).

21. Actualiza el archivo schema.yml en la carpeta library_loans para eliminar todas las pruebas (data_tests) de la fuente loans y aplicarlas al nuevo modelo stg_loans.

    ```yml
    version: 2

    sources:
      - name: library
        database: DBT_WORKSHOP_DB
        schema: library_loans
        tables:
          - name: books_factual
          - name: books_fictional
          - name: loans
          - name: members

    models:
      - name: stg_members
        columns:
          - name: member_id
            data_tests:
              - unique
              - not_null
          - name: membership_tier
            data_tests:
              - accepted_values:
                  values: ["Bronze", "Silver", "Gold"]
      - name: stg_books
        columns:
          - name: book_id
            data_tests:
              - unique
              - not_null
      - name: stg_loans
        columns:
          - name: loan_id
            data_tests:
              - unique
              - not_null
          - name: book_id
            data_tests:
              - relationships:
                  to: ref('stg_books')
                  field: book_id
          - name: member_id
            data_tests:
              - relationships:
                  to: ref('stg_members')
                  field: member_id
    ```

22. Actualiza el archivo customers_with_late_fees.sql para que haga referencia a nuestras nuevas tablas de staging, en lugar de las fuentes originales, usando la función ref(). También deberás modificar el SQL para reflejar que ahora solo hay una tabla stg_books en lugar de las dos fuentes de libros anteriores.

    ```sql
    WITH CTE AS (
        SELECT
            B.book_name as book_name,
            M.member_name,
            M.discount_rate/100 as discount_applied,
            SUM(L.late_fee * (M.discount_rate/100)) as fee_applied
        FROM {{ ref('stg_members') }} AS M
            INNER JOIN {{ ref('stg_loans') }} AS L ON M.member_id = L.member_id
            LEFT JOIN {{ ref('stg_books') }} AS B ON B.book_id=L.book_id
        GROUP BY 1,2,3
    )
    SELECT
    member_name,
    listagg(book_name::text, ',') as late_books,
    discount_applied,
    ROUND(SUM(fee_applied),2) as fee_to_pay
    FROM CTE
    GROUP BY 1,3
    ```

23. Crea un nuevo archivo llamado customer_withdrawals.sql en la carpeta library_loans (/models/library_loans/customer_withdrawals.sql).

24. Copia la consulta CTE de customers_with_late_fees.sql en customer_withdrawals.sql (líneas 2-10).

    ```sql
    SELECT
        B.book_name as book_name,
        M.member_name,
        M.discount_rate/100 as discount_applied,
        SUM(L.late_fee * (M.discount_rate/100)) as fee_applied
    FROM {{ ref('stg_members') }} AS M
        INNER JOIN {{ ref('stg_loans') }} AS L ON M.member_id = L.member_id
        LEFT JOIN {{ ref('stg_books') }} AS B ON B.book_id=L.book_id
    GROUP BY 1,2,3
    ```

25. Actualiza la CTE en customers_with_late_fees.sql (líneas 1-11) usando la función ref() para llamar al modelo customer_withdrawals.sql.

    ```SQL
    WITH CTE AS (
        SELECT *
        FROM {{ ref('customer_withdrawals') }}
    )
    SELECT
    member_name,
    listagg(book_name::text, ',') as late_books,
    discount_applied,
    ROUND(SUM(fee_applied),2) as fee_to_pay
    FROM CTE
    GROUP BY 1,3
    ```

26. En la barra de comandos, ejecuta el comando

    ```sh
    dbt build --select library_loans
    ```

    Para crear y probar todos los modelos de library_loans. Todos los tests deberían pasar.

27. Crear una carpeta dentro de la carpeta tests llamada generic ("/tests/generic").

28. En la carpeta de tests genéricos, crea un archivo SQL llamado no_negative_values.sql ("/tests/generic/no_negative_values.sql").

29. Copia/pega el siguiente SQL en el nuevo modelo.

    ```sql
    {% test no_negative_values(model, column_name)%}
        SELECT {{column_name}}
        FROM {{model}}
        WHERE {{column_name}} < 0
    {% endtest %}
    ```

30. Actualiza el archivo schema.yml en la carpeta library_loans ("/models/library_loans/schema.yml") para aplicar la prueba no_negative_values a la columna fee_applied del modelo customer_withdrawals al final del archivo.

    ```yml
    - name: customer_withdrawals
      columns:
        - name: fee_applied
          data_tests:
            - no_negative_values
    ```

    <details>
    <summary>schema.yml completo</summary>

    ```yml
    version: 2

    sources:
      - name: library
        database: DBT_WORKSHOP_DB
        schema: library_loans
        tables:
          - name: books_factual
          - name: books_fictional
          - name: loans
          - name: members

    models:
      - name: stg_members
        columns:
          - name: member_id
            data_tests:
              - unique
              - not_null
          - name: membership_tier
            data_tests:
              - accepted_values:
                  values: ["Bronze", "Silver", "Gold"]
      - name: stg_books
        columns:
          - name: book_id
            data_tests:
              - unique
              - not_null
      - name: stg_loans
        columns:
          - name: loan_id
            data_tests:
              - unique
              - not_null
          - name: book_id
            data_tests:
              - relationships:
                  to: ref('stg_books')
                  field: book_id
          - name: member_id
            data_tests:
              - relationships:
                  to: ref('stg_members')
                  field: member_id
      - name: customer_withdrawals
        columns:
          - name: fee_applied
            data_tests:
              - no_negative_values
    ```

    </details>

31. En la barra de comandos, ejecuta el comando

    ```sh
    dbt test --select customer_withdrawals
    ```

    para crear y probar todos los modelos en library_loans. Todos los tests deberían pasar.

32. Copia el YAML de instalación de dbt_utils en el archivo packages.yml.

33. Copia el YAML de instalación de [dbt_utils](https://hub.getdbt.com/dbt-labs/dbt_utils/latest/) dentro del archivo packages.yml.

    ```yml
    packages:
      - package: dbt-labs/dbt_utils
        version: 1.3.0
    ```

    (fíjate bien: tu versión puede variar)

34. En la barra de comandos, ejecuta el comando

    ```sh
    dbt deps
    ```

    Para instalar el paquete dbt_utils

35. Crea solucion.csv en la carpeta seeds ("/seeds/solucion.csv")

36. Abre el archivo inicial solucion.csv en un editor de texto y copia su contenido en /seeds/solucion.csv.

    <details>
    <summary>contenido de solucion.csv</summary>

    [solucion.csv](../archivos/solucion.csv)

    </details>

37. Actualiza el archivo schema.yml en la carpeta library_loans ("/models/library_loans/schema.yml") para añadir una sección seeds al final del archivo con el nombre solucion.

    ```yml
    seeds:
      - name: solucion
    ```

    <details>
    <summary>schema.yml completo</summary>

    ```yml
    version: 2

    sources:
      - name: library
        database: DBT_WORKSHOP_DB
        schema: library_loans
        tables:
          - name: books_factual
          - name: books_fictional
          - name: loans
          - name: members

    models:
      - name: stg_members
        columns:
          - name: member_id
            data_tests:
              - unique
              - not_null
          - name: membership_tier
            data_tests:
              - accepted_values:
                  values: ["Bronze", "Silver", "Gold"]
      - name: stg_books
        columns:
          - name: book_id
            data_tests:
              - unique
              - not_null
      - name: stg_loans
        columns:
          - name: loan_id
            data_tests:
              - unique
              - not_null
          - name: book_id
            data_tests:
              - relationships:
                  to: ref('stg_books')
                  field: book_id
          - name: member_id
            data_tests:
              - relationships:
                  to: ref('stg_members')
                  field: member_id
      - name: customer_withdrawals
        columns:
          - name: fee_applied
            data_tests:
              - no_negative_values

    seeds:
      - name: solucion
    ```

    </details>

38. En la barra de comandos, ejecuta el comando

    ```sh
    dbt seed
    ```

    Para cargar el archivo seed en el almacén de datos.

39. Actualiza el archivo schema.yml en la carpeta library_loans ("/models/library_loans/schema.yml") para agregar el test [dbt_utils.equal_rowcount](https://github.com/dbt-labs/dbt-utils/tree/1.3.0/#equal_rowcount-source) al modelo customers_with_late_fees, comparándolo con el seed solucion.

Además, agrega un [accepted_range test](https://github.com/dbt-labs/dbt-utils/tree/1.3.0/#accepted_range-source) en la columna discount_applied para verificar que sus valores estén entre 0 y 25 %.

    ```yml
    - name: customers_with_late_fees
      data_tests:
        - dbt_utils.equal_rowcount:
            compare_model: ref('solucion')
      columns:
        - name: discount_applied
          data_tests:
            - dbt_utils.accepted_range:
                min_value: 0
                max_value: 0.25
    ```

    <details>
    <summary>schema.yml completo</summary>

    ```yml
    version: 2

    sources:
      - name: library
        database: DBT_WORKSHOP_DB
        schema: library_loans
        tables:
          - name: books_factual
          - name: books_fictional
          - name: loans
          - name: members

    models:
      - name: stg_members
        columns:
          - name: member_id
            data_tests:
              - unique
              - not_null
          - name: membership_tier
            data_tests:
              - accepted_values:
                  values: ["Bronze", "Silver", "Gold"]
      - name: stg_books
        columns:
          - name: book_id
            data_tests:
              - unique
              - not_null
      - name: stg_loans
        columns:
          - name: loan_id
            data_tests:
              - unique
              - not_null
          - name: book_id
            data_tests:
              - relationships:
                  to: ref('stg_books')
                  field: book_id
          - name: member_id
            data_tests:
              - relationships:
                  to: ref('stg_members')
                  field: member_id
      - name: customer_withdrawals
        columns:
          - name: fee_applied
            data_tests:
              - no_negative_values
      - name: customers_with_late_fees
        data_tests:
          - dbt_utils.equal_rowcount:
              compare_model: ref('solucion')
        columns:
          - name: discount_applied
            data_tests:
              - dbt_utils.accepted_range:
                  min_value: 0
                  max_value: 0.25

    seeds:
      - name: solucion
    ```

    </details>

40. En la barra de comandos, ejecuta el comando

    ```sh
    dbt test --select customers_with_late_fees
    ```

    Para ver estos tests ejecutárse (y pasando) sobre el modelo customers_with_late_fees.

41. En la barra de comandos, ejecuta el comando

    ```sh
    dbt build --select library_loans
    ```

    Para crear y probar todos los modelos de library_loans. Todos los tests deberían pasar.

### [Lista de Guias](../ReadMe.md)